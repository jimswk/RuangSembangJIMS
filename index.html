<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JIMS Ruang Sembang</title>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontSize: { 'xs': '0.75rem', 'sm': '0.875rem', 'base': '1rem', 'lg': '1.125rem', 'xl': '1.25rem' }
        }
      }
    }
  </script>

  <!-- Notifikasi Bunyi -->
  <audio id="notificationSound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 h-screen overflow-hidden">
  <div id="root"></div>

  <script type="text/babel">
    // ðŸ”‘ Gantikan dengan URL & Key dari Supabase Anda
    const supabaseUrl = 'https://yrmxxburxopztabpodwk.supabase.co'; // GANTI INI
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlybXh4YnVyeG9wenRhYnBvZHdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4OTk5NDAsImV4cCI6MjA3MDQ3NTk0MH0.3W-oTgA1YOsiYHozu-F4YUf9BfIyUI_hOP46IDek_KY';       // GANTI INI

    const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

    const { useState, useEffect, useRef } = React;

    // Popup Alert
    const PopupAlert = ({ message, type = "info", onClose }) => {
      useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
      const bgColor = type === "success" ? "bg-green-500" : "bg-blue-500";
      return (
        <div className={`fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded shadow-lg z-50`}>
          {message}
        </div>
      );
    };

    // Context Menu
    const ContextMenu = ({ show, x, y, onClose, onAction }) => {
      if (!show) return null;
      return (
        <div
          className="absolute z-50 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded shadow-lg py-1 text-sm"
          style={{ left: x, top: y }}
          onMouseLeave={onClose}
        >
          {['Info Mesej', 'Balas', 'Salin', 'Reaksi', 'Majukan', 'Sematkan', 'Bintang', 'Sunting', 'Padam'].map(a => (
            <div key={a} className="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer" onClick={() => { onAction(a); onClose(); }}>
              {a}
            </div>
          ))}
        </div>
      );
    };

    // App
    const App = () => {
      const [user, setUser] = useState(null);
      const [isAdmin, setIsAdmin] = useState(false);
      const [loading, setLoading] = useState(true);
      const [alert, setAlert] = useState({ show: false, msg: '', type: 'info' });
      const [darkMode, setDarkMode] = useState(false);
      const [textSize, setTextSize] = useState('base');
      const [authStep, setAuthStep] = useState('login');
      const [contextMenu, setContextMenu] = useState({ show: false, x: 0, y: 0, message: null });
      const [pinnedMessages, setPinnedMessages] = useState([]);

      const notificationSound = document.getElementById('notificationSound');

      useEffect(() => {
        const { data: authListener } = supabase.auth.onAuthStateChange(async (event, session) => {
          if (session?.user) {
            const u = session.user;
            await upsertUser(u);
            setUser(u);
            setIsAdmin(u.email?.endsWith('@imi.gov.my'));
          } else {
            setUser(null);
            setIsAdmin(false);
          }
          setLoading(false);
        });

        return () => authListener.subscription.unsubscribe();
      }, []);

      const upsertUser = async (u) => {
        const { error } = await supabase.from('users').upsert({
          id: u.id,
          email: u.email,
          online: true,
          last_seen: new Date(),
          created_at: u.created_at
        });
        if (error) console.error("Error upsert user:", error);
      };

      useEffect(() => {
        if (darkMode) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
      }, [darkMode]);

      const showAlert = (msg, type = 'info') => {
        setAlert({ show: true, msg, type });
        setTimeout(() => setAlert(prev => prev.msg === msg ? { ...prev, show: false } : prev), 3000);
      };

      const playNotif = () => {
        notificationSound.currentTime = 0;
        notificationSound.play().catch(() => {});
      };

      const handleLogout = async () => {
        if (user) {
          await supabase.from('users').update({ online: false, last_seen: new Date() }).eq('id', user.id);
        }
        await supabase.auth.signOut();
        setUser(null);
        showAlert("Berjaya log keluar", "success");
      };

      if (loading) return <div className="flex items-center justify-center h-screen">Memuatkan...</div>;

      return (
        <div className={`flex flex-col h-screen ${textSize}`}>
          {alert.show && <PopupAlert message={alert.msg} type={alert.type} onClose={() => setAlert({ ...alert, show: false })} />}
          {user ? (
            <ChatApp
              user={user}
              isAdmin={isAdmin}
              darkMode={darkMode}
              setDarkMode={setDarkMode}
              textSize={textSize}
              setTextSize={setTextSize}
              handleLogout={handleLogout}
              showAlert={showAlert}
              contextMenu={contextMenu}
              setContextMenu={setContextMenu}
              playNotif={playNotif}
              pinnedMessages={pinnedMessages}
              setPinnedMessages={setPinnedMessages}
            />
          ) : (
            <AuthScreen setAuthStep={setAuthStep} authStep={authStep} showAlert={showAlert} />
          )}
          {contextMenu.show && (
            <ContextMenu
              show={contextMenu.show}
              x={contextMenu.x}
              y={contextMenu.y}
              onClose={() => setContextMenu({ show: false })}
              onAction={(action) => {
                const msg = contextMenu.message;
                if (action === 'Padam') {
                  supabase.from('messages').delete().eq('id', msg.id);
                } else if (action === 'Sematkan') {
                  setPinnedMessages(prev => [...prev, msg]);
                  showAlert("Mesej disematkan", "success");
                }
                setContextMenu({ show: false });
              }}
            />
          )}
        </div>
      );
    };

    // AuthScreen
    const AuthScreen = ({ authStep, setAuthStep, showAlert }) => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');

      const submit = async (e) => {
        e.preventDefault();
        try {
          if (authStep === 'login') {
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) throw error;
            showAlert("Log masuk berjaya!", "success");
          } else if (authStep === 'register') {
            const { error } = await supabase.auth.signUp({ email, password });
            if (error) throw error;
            showAlert("Pendaftaran berjaya! Semak emel untuk pengesahan.", "success");
          } else if (authStep === 'forgot') {
            const { error } = await supabase.auth.resetPasswordForEmail(email);
            if (error) throw error;
            showAlert("Pautan set semula dihantar.", "success");
            setAuthStep('login');
          }
        } catch (err) {
          showAlert(err.message, "error");
        }
      };

      return (
        <div className="flex h-full items-center justify-center bg-gray-50 dark:bg-gray-900">
          <div className="w-96 p-8 bg-white dark:bg-gray-800 rounded shadow">
            <h2 className="text-2xl font-bold mb-6 text-center">{authStep === 'login' ? 'Log Masuk' : authStep === 'register' ? 'Daftar' : 'Lupa Kata Laluan'}</h2>
            <form onSubmit={submit}>
              <input type="email" placeholder="Emel" value={email} onChange={e => setEmail(e.target.value)} required className="w-full p-2 mb-4 border rounded dark:bg-gray-700" />
              {authStep !== 'forgot' && <input type="password" placeholder="Kata Laluan" value={password} onChange={e => setPassword(e.target.value)} required className="w-full p-2 mb-4 border rounded dark:bg-gray-700" />}
              <button type="submit" className="w-full bg-blue-500 hover:bg-blue-600 text-white p-2 rounded">Hantar</button>
            </form>
            <div className="mt-4 text-center">
              {authStep === 'login' ? (
                <>
                  <div><a onClick={() => setAuthStep('forgot')} className="text-blue-500 cursor-pointer">Lupa kata laluan?</a></div>
                  <div><a onClick={() => setAuthStep('register')} className="text-blue-500 cursor-pointer">Daftar akaun</a></div>
                </>
              ) : (
                <div><a onClick={() => setAuthStep('login')} className="text-blue-500 cursor-pointer">Sudah ada akaun? Log masuk</a></div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ChatApp
    const ChatApp = ({
      user, isAdmin, darkMode, setDarkMode, textSize, setTextSize,
      handleLogout, showAlert, contextMenu, setContextMenu, playNotif,
      pinnedMessages, setPinnedMessages
    }) => {
      const [channels, setChannels] = useState([]);
      const [onlineUsers, setOnlineUsers] = useState([]);
      const [activeChat, setActiveChat] = useState(null);
      const [messages, setMessages] = useState([]);
      const [newMessage, setNewMessage] = useState('');
      const [searchQuery, setSearchQuery] = useState('');
      const [showCreate, setShowCreate] = useState(false);
      const [newChan, setNewChan] = useState('');
      const [newDesc, setNewDesc] = useState('');
      const [showGroup, setShowGroup] = useState(false);
      const [selectedUsers, setSelectedUsers] = useState([]);
      const [typing, setTyping] = useState('');
      const messagesEndRef = useRef(null);

      const scrollToBottom = () => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });

      // Load data awal
      useEffect(() => {
        fetchChannels();
        fetchUsers();

        const channel = supabase.channel('realtime data')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
            setMessages(msgs => [...msgs, payload.new]);
            if (payload.new.sender_id !== user.id && activeChat?.id === payload.new.chat_id) playNotif();
            scrollToBottom();
          })
          .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'users' }, payload => {
            fetchUsers();
          })
          .subscribe();

        return () => {
          supabase.removeChannel(channel);
        };
      }, [activeChat]);

      const fetchChannels = async () => {
        const { data, error } = await supabase.from('channels').select('*');
        if (error) console.error("Error fetching channels:", error);
        else setChannels(data);
      };

      const fetchUsers = async () => {
        const { data, error } = await supabase.from('users').select('*').eq('online', true);
        if (error) console.error("Error fetching users:", error);
        else setOnlineUsers(data.filter(u => u.id !== user.id));
      };

      useEffect(() => {
        if (activeChat?.id) {
          fetchMessages(activeChat.id);
        }
      }, [activeChat]);

      const fetchMessages = async (chatId) => {
        const { data, error } = await supabase
          .from('messages')
          .select('*, sender:sender_id(email)')
          .eq('chat_id', chatId)
          .order('created_at', { ascending: true });
        if (error) console.error("Error fetching messages:", error);
        else setMessages(data);
      };

      const sendMessage = async () => {
        if (!newMessage.trim() || !activeChat) return;
        const { error } = await supabase.from('messages').insert([{
          text: newMessage,
          sender_id: user.id,
          chat_id: activeChat.id,
          type: activeChat.type
        }]);
        if (error) console.error("Send error:", error);
        else setNewMessage('');
      };

      const createChannel = async () => {
        if (!newChan) return;
        const { error } = await supabase.from('channels').insert([{
          name: newChan,
          description: newDesc,
          created_by: user.id,
          created_at: new Date()
        }]);
        if (!error) {
          setNewChan('');
          setNewDesc('');
          setShowCreate(false);
          fetchChannels();
          showAlert(`Channel "${newChan}" dibuat!`, "success");
        }
      };

      const createGroupDM = () => {
        if (selectedUsers.length === 0) return;
        const ids = [user.id, ...selectedUsers].sort();
        const dmId = ids.join('_');
        const name = [user.email, ...selectedUsers.map(uid => onlineUsers.find(u => u.id === uid)?.email)].join(', ');
        setActiveChat({ type: 'dm', id: dmId, name });
        setSelectedUsers([]);
        setShowGroup(false);
      };

      const addReaction = async (msgId, emoji) => {
        const { data: msg } = await supabase.from('messages').select('reactions').eq('id', msgId).single();
        const reactions = { ...msg.reactions, [emoji]: (msg.reactions?.[emoji] || 0) + 1 };
        await supabase.from('messages').update({ reactions }).eq('id', msgId);
      };

      const deleteChannel = async (id) => {
        if (window.confirm("Padam channel ini?")) {
          await supabase.from('channels').delete().eq('id', id);
          await supabase.from('messages').delete().eq('chat_id', id);
          if (activeChat?.id === id) setActiveChat(null);
          fetchChannels();
          showAlert("Channel dipadam", "success");
        }
      };

      const leaveChat = () => setActiveChat(null);

      const filteredChannels = channels.filter(c => c.name.toLowerCase().includes(searchQuery.toLowerCase()));
      const filteredUsers = onlineUsers.filter(u => u.email.toLowerCase().includes(searchQuery.toLowerCase()));

      return (
        <div className="flex h-full">
          {/* Sidebar */}
          <div className="w-80 bg-white dark:bg-gray-800 border-r dark:border-gray-700 flex flex-col">
            <div className="p-4 border-b dark:border-gray-700">
              <h1 className="text-xl font-bold">JIMS Sembang</h1>
              <button onClick={handleLogout} className="text-sm text-red-500">Keluar</button>
            </div>

            <div className="p-2">
              <input
                type="text"
                placeholder="Cari..."
                value={searchQuery}
                onChange={e => setSearchQuery(e.target.value)}
                className="w-full p-2 border rounded dark:bg-gray-700"
              />
            </div>

            <div className="p-2 space-y-2 text-sm">
              <label className="flex items-center">
                <input type="checkbox" checked={darkMode} onChange={() => setDarkMode(!darkMode)} className="mr-2" />
                Dark Mode
              </label>
              <select value={textSize} onChange={e => setTextSize(e.target.value)} className="w-full p-1 border rounded dark:bg-gray-700">
                {['xs', 'sm', 'base', 'lg', 'xl'].map(s => <option key={s} value={s}>{s}</option>)}
              </select>
            </div>

            <div className="flex-1 overflow-y-auto p-2">
              <h3 className="font-semibold mb-2">Online ({onlineUsers.length})</h3>
              {filteredUsers.map(u => (
                <div key={u.id} className="flex items-center p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm cursor-pointer" onClick={() => setActiveChat({ type: 'dm', id: [user.id, u.id].sort().join('_'), name: u.email })}>
                  <div className="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-xs">{u.email[0].toUpperCase()}</div>
                  <span className="ml-2">{u.email}</span>
                </div>
              ))}

              <div className="flex justify-between mt-4">
                <h3 className="font-semibold">Channels</h3>
                {isAdmin && <button onClick={() => setShowCreate(true)} className="text-xs bg-blue-100 dark:bg-blue-900 px-1 rounded">+</button>}
                <button onClick={() => setShowGroup(true)} className="text-xs bg-gray-100 dark:bg-gray-700 px-1 rounded">Group</button>
              </div>

              {showCreate && isAdmin && (
                <div className="p-2 border rounded bg-gray-50 dark:bg-gray-700 mb-2">
                  <input placeholder="Nama channel" value={newChan} onChange={e => setNewChan(e.target.value)} className="w-full p-1 mb-1 border rounded text-sm dark:bg-gray-600" />
                  <textarea placeholder="Deskripsi" value={newDesc} onChange={e => setNewDesc(e.target.value)} className="w-full p-1 mb-1 border rounded text-sm dark:bg-gray-600" rows="1" />
                  <button onClick={createChannel} className="bg-green-500 text-white px-2 py-0.5 text-xs rounded mr-1">Buat</button>
                  <button onClick={() => setShowCreate(false)} className="bg-gray-300 dark:bg-gray-600 px-2 py-0.5 text-xs rounded">Batal</button>
                </div>
              )}

              {showGroup && (
                <div className="p-2 border rounded bg-gray-50 dark:bg-gray-700 mb-2">
                  {onlineUsers.map(u => (
                    <label key={u.id} className="flex items-center text-xs p-1">
                      <input type="checkbox" checked={selectedUsers.includes(u.id)} onChange={e => {
                        if (e.target.checked) setSelectedUsers(s => [...s, u.id]);
                        else setSelectedUsers(s => s.filter(id => id !== u.id));
                      }} className="mr-1" />
                      {u.email}
                    </label>
                  ))}
                  <button onClick={createGroupDM} className="bg-blue-500 text-white px-2 py-0.5 text-xs rounded mr-1">Buat</button>
                  <button onClick={() => setShowGroup(false)} className="bg-gray-300 dark:bg-gray-600 px-2 py-0.5 text-xs rounded">Batal</button>
                </div>
              )}

              {filteredChannels.map(c => (
                <div key={c.id} className="flex justify-between items-center p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm">
                  <span onClick={() => setActiveChat({ type: 'channel', id: c.id, name: c.name, description: c.description })} className="cursor-pointer">#{c.name}</span>
                  {activeChat?.id === c.id && <button onClick={leaveChat} className="text-xs text-red-500">Keluar</button>}
                  {isAdmin && <button onClick={() => deleteChannel(c.id)} className="text-xs text-red-700">Ã—</button>}
                </div>
              ))}
            </div>
          </div>

          {/* Chat Area */}
          {!activeChat ? (
            <div className="flex-1 flex items-center justify-center text-gray-500">Pilih channel atau pengguna</div>
          ) : (
            <div className="flex-1 flex flex-col">
              <div className="p-3 border-b bg-white dark:bg-gray-800 flex items-center justify-between">
                <h2 className="font-bold">{activeChat.name}</h2>
                {activeChat.description && <span className="text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-1 rounded">{activeChat.description}</span>}
              </div>

              {pinnedMessages.length > 0 && (
                <div className="bg-yellow-50 dark:bg-yellow-900 border-b p-2 text-xs">
                  {pinnedMessages.map(m => <div key={m.id}>ðŸ“Œ {m.text.substring(0, 30)}...</div>)}
                </div>
              )}

              <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-gray-900" onContextMenu={e => e.preventDefault()}>
                {messages.map(m => (
                  <div
                    key={m.id}
                    onContextMenu={e => {
                      e.preventDefault();
                      setContextMenu({ show: true, x: e.pageX, y: e.pageY, message: m });
                    }}
                    className={`flex ${m.sender_id === user.id ? 'justify-end' : 'justify-start'}`}
                  >
                    <div className={`max-w-xs lg:max-w-md px-3 py-2 rounded-lg ${
                      m.sender_id === user.id ? 'bg-blue-500 text-white' : 'bg-white dark:bg-gray-700 shadow'
                    }`}>
                      <p className="text-sm">{m.text}</p>
                      <p className="text-xs mt-1 opacity-70">{new Date(m.created_at).toLocaleTimeString()}</p>
                      {m.reactions && (
                        <div className="flex gap-1 mt-1">
                          {Object.entries(m.reactions).map(([e, c]) => (
                            <span key={e} className="bg-gray-200 dark:bg-gray-600 px-1 rounded text-xs">{e}{c}</span>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                ))}
                {typing && <div className="text-xs text-gray-500 px-4">ðŸ’¬ {typing} sedang menaip...</div>}
                <div ref={messagesEndRef} />
              </div>

              <div className="p-3 bg-white dark:bg-gray-800 border-t">
                <div className="flex">
                  <input
                    type="text"
                    value={newMessage}
                    onChange={e => setNewMessage(e.target.value)}
                    onKeyPress={e => e.key === 'Enter' && sendMessage()}
                    placeholder="Taip mesej..."
                    className="flex-1 p-2 border rounded-l focus:outline-none dark:bg-gray-700 dark:border-gray-600"
                  />
                  <button onClick={sendMessage} className="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-r">Hantar</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
