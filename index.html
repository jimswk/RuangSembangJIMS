<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JIMS Ruang Sembang</title>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontSize: { 'xs': '0.75rem', 'sm': '0.875rem', 'base': '1rem', 'lg': '1.125rem', 'xl': '1.25rem' }
        }
      }
    }
  </script>

  <!-- Notifikasi Bunyi -->
  <audio id="notificationSound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 h-screen overflow-hidden">
  <div id="root"></div>

  <script type="text/babel">
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyA8L6_srjWF7mk-7k5UGk2vH_klYYOkU5U",
      authDomain: "ruangsembangjimsv2.firebaseapp.com",
      projectId: "ruangsembangjimsv2",
      storageBucket: "ruangsembangjimsv2.firebasestorage.app",
      messagingSenderId: "180755101546",
      appId: "1:180755101546:web:5bd96908400e3f59689713",
      measurementId: "G-76BVBVGYZ1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const { useState, useEffect, useRef } = React;

    // Popup Alert
    const PopupAlert = ({ message, type = "info", onClose }) => {
      useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
      const bgColor = type === "success" ? "bg-green-500" : "bg-blue-500";
      return (
        <div className={`fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded shadow-lg z-50`}>
          {message}
        </div>
      );
    };

    // Reaction Picker
    const ReactionPicker = ({ x, y, onPick, onClose }) => {
      const emojis = ['👍', '❤️', '�', '🎉', '🔥', '👏', '👀', '🙏', '😢'];
      const pickerRef = useRef(null);

      useEffect(() => {
        const handleClickOutside = (event) => {
          if (pickerRef.current && !pickerRef.current.contains(event.target)) {
            onClose();
          }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => {
          document.removeEventListener("mousedown", handleClickOutside);
        };
      }, [onClose]);

      return (
        <div
          ref={pickerRef}
          className="absolute z-50 p-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-full shadow-lg flex space-x-2"
          style={{ top: y, left: x }}
        >
          {emojis.map(emoji => (
            <button key={emoji} onClick={() => onPick(emoji)} className="text-xl p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors duration-200">
              {emoji}
            </button>
          ))}
        </div>
      );
    };

    // App
    const App = () => {
      const [user, setUser] = useState(null);
      const [isAdmin, setIsAdmin] = useState(false);
      const [loading, setLoading] = useState(true);
      const [alert, setAlert] = useState({ show: false, msg: '', type: 'info' });
      const [darkMode, setDarkMode] = useState(false);
      const [textSize, setTextSize] = useState('base');
      const [authStep, setAuthStep] = useState('login');
      const [reactionState, setReactionState] = useState({ show: false, x: 0, y: 0, messageId: null });
      const [unreadCounts, setUnreadCounts] = useState({});
      const [lastReadTimestamps, setLastReadTimestamps] = useState({});
      const [onlineUsers, setOnlineUsers] = useState([]);
      const [channels, setChannels] = useState([]);

      const notificationSound = document.getElementById('notificationSound');

      const handleLogout = async () => {
        if (user) {
          await db.collection('users').doc(user.uid).update({ online: false, lastSeen: new Date() });
          await auth.signOut();
        }
        setUser(null);
        showAlert("Berjaya log keluar", "success");
      };

      // Efek untuk autentikasi dan status pengguna
      useEffect(() => {
        const unsub = auth.onAuthStateChanged(async (u) => {
          if (u) {
            await db.collection('users').doc(u.uid).set({
              uid: u.uid,
              email: u.email,
              online: true,
              lastReadTimestamps: {},
              lastSeen: new Date()
            }, { merge: true });
            setUser(u);
            setIsAdmin(u.email?.endsWith('@imi.gov.my'));
          } else {
            setUser(null);
            setIsAdmin(false);
          }
          setLoading(false);
        });

        // Efek untuk log keluar automatik
        const handleBeforeUnload = async () => {
          if (auth.currentUser) {
            await db.collection('users').doc(auth.currentUser.uid).update({ online: false, lastSeen: new Date() });
          }
        };
        window.addEventListener('beforeunload', handleBeforeUnload);

        return () => {
          unsub();
          window.removeEventListener('beforeunload', handleBeforeUnload);
        };
      }, []);

      useEffect(() => {
        if (darkMode) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
      }, [darkMode]);

      const showAlert = (msg, type = 'info') => {
        setAlert({ show: true, msg, type });
        setTimeout(() => setAlert(prev => prev.msg === msg ? { ...prev, show: false } : prev), 3000);
      };

      const playNotif = () => {
        notificationSound.currentTime = 0;
        notificationSound.play().catch(() => {});
      };

      const handleReactionPick = async (emoji) => {
        if (!reactionState.messageId) return;
        const ref = db.collection('messages').doc(reactionState.messageId);
        const snap = await ref.get();
        const reactions = { ...(snap.data()?.reactions || {}) };
        reactions[emoji] = (reactions[emoji] || 0) + 1;
        await ref.update({ reactions });
        setReactionState({ show: false, x: 0, y: 0, messageId: null });
        showAlert(`Reaksi: ${emoji}`, "success");
      };

      if (loading) return <div className="flex items-center justify-center h-screen">Memuatkan...</div>;

      return (
        <div className={`flex flex-col h-screen ${textSize}`}>
          {alert.show && <PopupAlert message={alert.msg} type={alert.type} onClose={() => setAlert({ ...alert, show: false })} />}
          {user ? (
            <ChatApp
              user={user}
              isAdmin={isAdmin}
              darkMode={darkMode}
              setDarkMode={setDarkMode}
              textSize={textSize}
              setTextSize={setTextSize}
              handleLogout={handleLogout}
              showAlert={showAlert}
              setReactionState={setReactionState}
              playNotif={playNotif}
              unreadCounts={unreadCounts}
              setUnreadCounts={setUnreadCounts}
              lastReadTimestamps={lastReadTimestamps}
              setLastReadTimestamps={setLastReadTimestamps}
              onlineUsers={onlineUsers}
              setOnlineUsers={setOnlineUsers}
              channels={channels}
              setChannels={setChannels}
            />
          ) : (
            <AuthScreen setAuthStep={setAuthStep} authStep={authStep} showAlert={showAlert} />
          )}
          {reactionState.show && (
            <ReactionPicker
              x={reactionState.x}
              y={reactionState.y}
              onPick={handleReactionPick}
              onClose={() => setReactionState({ show: false, x: 0, y: 0, messageId: null })}
            />
          )}
        </div>
      );
    };

    // AuthScreen
    const AuthScreen = ({ authStep, setAuthStep, showAlert }) => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [confirm, setConfirm] = useState('');

      const submit = async (e) => {
        e.preventDefault();
        try {
          if (authStep === 'login') {
            await auth.signInWithEmailAndPassword(email, password);
            showAlert("Log masuk berjaya!", "success");
          } else if (authStep === 'register') {
            if (password !== confirm) return showAlert("Kata laluan tak sepadan", "error");
            await auth.createUserWithEmailAndPassword(email, password);
            showAlert("Akaun berjaya didaftarkan!", "success");
          } else if (authStep === 'forgot') {
            await auth.sendPasswordResetEmail(email);
            showAlert("Pautan set semula dihantar.", "success");
            setAuthStep('login');
          }
        } catch (err) {
          showAlert(err.message, "error");
        }
      };

      return (
        <div className="flex h-full items-center justify-center bg-gray-50 dark:bg-gray-900">
          <div className="w-96 p-8 bg-white dark:bg-gray-800 rounded shadow">
            <h2 className="text-2xl font-bold mb-6 text-center">{authStep === 'login' ? 'Log Masuk' : authStep === 'register' ? 'Daftar' : 'Lupa Kata Laluan'}</h2>
            <form onSubmit={submit}>
              <input type="email" placeholder="Emel" value={email} onChange={e => setEmail(e.target.value)} required className="w-full p-2 mb-4 border rounded dark:bg-gray-700" />
              {authStep !== 'forgot' && <input type="password" placeholder="Kata Laluan" value={password} onChange={e => setPassword(e.target.value)} required className="w-full p-2 mb-4 border rounded dark:bg-gray-700" />}
              {authStep === 'register' && <input type="password" placeholder="Sahkan" value={confirm} onChange={e => setConfirm(e.target.value)} required className="w-full p-2 mb-4 border rounded dark:bg-gray-700" />}
              <button type="submit" className="w-full bg-blue-500 hover:bg-blue-600 text-white p-2 rounded">Hantar</button>
            </form>
            <div className="mt-4 text-center">
              {authStep === 'login' ? (
                <>
                  <div><a onClick={() => setAuthStep('forgot')} className="text-blue-500 cursor-pointer">Lupa kata laluan?</a></div>
                  <div><a onClick={() => setAuthStep('register')} className="text-blue-500 cursor-pointer">Daftar akaun</a></div>
                </>
              ) : (
                <div><a onClick={() => setAuthStep('login')} className="text-blue-500 cursor-pointer">Sudah ada akaun? Log masuk</a></div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ChatApp
    const ChatApp = ({
      user, isAdmin, darkMode, setDarkMode, textSize, setTextSize,
      handleLogout, showAlert, setReactionState, playNotif,
      unreadCounts, setUnreadCounts, lastReadTimestamps, setLastReadTimestamps,
      onlineUsers, setOnlineUsers, channels, setChannels
    }) => {
      const [activeChat, setActiveChat] = useState(null);
      const [messages, setMessages] = useState([]);
      const [newMessage, setNewMessage] = useState('');
      const [searchQuery, setSearchQuery] = useState('');
      const [showCreate, setShowCreate] = useState(false);
      const [newChan, setNewChan] = useState('');
      const [newDesc, setNewDesc] = useState('');
      const messagesEndRef = useRef(null);

      const scrollToBottom = () => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });

      // Efek untuk mengambil data channels, users dan unread messages
      useEffect(() => {
        const unsubCh = db.collection('channels').onSnapshot(s => {
          setChannels(s.docs.map(d => ({ id: d.id, ...d.data() })));
        });

        const unsubU = db.collection('users').onSnapshot(s => {
          setOnlineUsers(s.docs.map(d => ({ id: d.id, ...d.data() })));
        });

        if (user) {
          const unsubUserDoc = db.collection('users').doc(user.uid).onSnapshot(doc => {
            const data = doc.data();
            if (data?.lastReadTimestamps) {
              setLastReadTimestamps(data.lastReadTimestamps);
            }
          });
          return () => { unsubCh(); unsubU(); unsubUserDoc(); };
        }
        return () => { unsubCh(); unsubU(); };
      }, [user]);

      // Efek untuk mendapatkan mesej dan menjejak mesej belum dibaca
      useEffect(() => {
        if (!activeChat?.id) return;

        // Mendapatkan mesej
        const unsub = db.collection('messages')
          .where('chatId', '==', activeChat.id)
          .orderBy('timestamp', 'asc')
          .onSnapshot(snap => {
            const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            setMessages(msgs);
            
            // Mengira mesej belum dibaca
            const unread = msgs.filter(m => {
              const lastRead = lastReadTimestamps[activeChat.id]?.toDate() || new Date(0);
              return m.timestamp.toDate() > lastRead && m.senderId !== user.uid;
            });
            
            setUnreadCounts(prev => ({ ...prev, [activeChat.id]: unread.length }));
            
            if (unread.length > 0) playNotif();
            scrollToBottom();
          }, err => console.error("Snapshot error:", err));
        
        return () => unsub();
      }, [activeChat, lastReadTimestamps]);

      // Fungsi untuk mengemas kini timestamp terakhir dibaca
      const updateLastRead = (chatId) => {
        if (user) {
          const updateData = { [`lastReadTimestamps.${chatId}`]: new Date() };
          db.collection('users').doc(user.uid).update(updateData);
        }
      };

      const sendMessage = async () => {
        if (!newMessage.trim()) return;
        const msgData = {
          text: newMessage,
          senderId: user.uid,
          senderEmail: user.email,
          chatId: activeChat?.id,
          timestamp: new Date(),
          type: activeChat?.type,
          edited: false,
          starred: false,
          pinned: false,
          reactions: {}
        };
        await db.collection('messages').add(msgData);
        setNewMessage('');
        updateLastRead(activeChat.id);
      };

      const createChannel = async () => {
        if (!newChan) return;
        await db.collection('channels').add({ name: newChan, description: newDesc, createdBy: user.uid, createdAt: new Date() });
        setNewChan(''); setNewDesc(''); setShowCreate(false);
        showAlert(`Channel "${newChan}" dibuat!`, "success");
      };

      const filteredChannels = channels.filter(c => c.name.toLowerCase().includes(searchQuery.toLowerCase()));
      const filteredUsers = onlineUsers.filter(u => u.id !== user.uid && u.email.toLowerCase().includes(searchQuery.toLowerCase()));
      
      const handleContextMenu = (e, message) => {
        e.preventDefault();
        setReactionState({
          show: true,
          x: e.pageX - 100, // Adjust X position for better placement
          y: e.pageY - 50,  // Adjust Y position to be above the cursor
          messageId: message.id
        });
      };

      return (
        <div className="flex h-full">
          {/* Sidebar */}
          <div className="w-80 bg-white dark:bg-gray-800 border-r dark:border-gray-700 flex flex-col">
            <div className="p-4 border-b dark:border-gray-700 flex justify-between items-center">
              <h1 className="text-xl font-bold">JIMS Sembang</h1>
              <button onClick={handleLogout} className="text-sm text-red-500">Keluar</button>
            </div>

            <div className="p-2">
              <input
                type="text"
                placeholder="Cari..."
                value={searchQuery}
                onChange={e => setSearchQuery(e.target.value)}
                className="w-full p-2 border rounded dark:bg-gray-700"
              />
            </div>

            <div className="p-2 space-y-2 text-sm">
              <label className="flex items-center">
                <input type="checkbox" checked={darkMode} onChange={() => setDarkMode(!darkMode)} className="mr-2" />
                Dark Mode
              </label>
              <select value={textSize} onChange={e => setTextSize(e.target.value)} className="w-full p-1 border rounded dark:bg-gray-700">
                {['xs', 'sm', 'base', 'lg', 'xl'].map(s => <option key={s} value={s}>{s}</option>)}
              </select>
            </div>

            <div className="flex-1 overflow-y-auto p-2">
              <h3 className="font-semibold mb-2">Online ({onlineUsers.length - 1})</h3>
              {filteredUsers.map(u => {
                const dmChatId = [user.uid, u.id].sort().join('_');
                const unread = unreadCounts[dmChatId] > 0;
                return (
                  <div key={u.id} className="flex items-center p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm cursor-pointer" onClick={() => {
                    setActiveChat({ type: 'dm', id: dmChatId, name: u.email });
                    updateLastRead(dmChatId);
                  }}>
                    <div className="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-xs">{u.email[0].toUpperCase()}</div>
                    <span className="ml-2">{u.email}</span>
                    {unread && <span className="ml-auto bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">{unreadCounts[dmChatId]}</span>}
                  </div>
                )
              })}

              <div className="flex justify-between mt-4">
                <h3 className="font-semibold">Channels</h3>
                {isAdmin && <button onClick={() => setShowCreate(true)} className="text-xs bg-blue-100 dark:bg-blue-900 px-1 rounded">+</button>}
              </div>

              {showCreate && isAdmin && (
                <div className="p-2 border rounded bg-gray-50 dark:bg-gray-700 mb-2">
                  <input placeholder="Nama channel" value={newChan} onChange={e => setNewChan(e.target.value)} className="w-full p-1 mb-1 border rounded text-sm dark:bg-gray-600" />
                  <textarea placeholder="Deskripsi" value={newDesc} onChange={e => setNewDesc(e.target.value)} className="w-full p-1 mb-1 border rounded text-sm dark:bg-gray-600" rows="1" />
                  <button onClick={createChannel} className="bg-green-500 text-white px-2 py-0.5 text-xs rounded mr-1">Buat</button>
                  <button onClick={() => setShowCreate(false)} className="bg-gray-300 dark:bg-gray-600 px-2 py-0.5 text-xs rounded">Batal</button>
                </div>
              )}

              {filteredChannels.map(c => {
                const unread = unreadCounts[c.id] > 0;
                return (
                  <div key={c.id} className="flex justify-between items-center p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm">
                    <span onClick={() => { setActiveChat({ type: 'channel', id: c.id, name: c.name, description: c.description }); updateLastRead(c.id); }} className="cursor-pointer">#{c.name}</span>
                    {unread && <span className="ml-auto bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">{unreadCounts[c.id]}</span>}
                    {isAdmin && <button onClick={() => db.collection('channels').doc(c.id).delete()} className="text-xs text-red-700">×</button>}
                  </div>
                )
              })}
            </div>
          </div>

          {/* Chat Area */}
          {!activeChat ? (
            <div className="flex-1 flex items-center justify-center text-gray-500">Pilih channel atau pengguna</div>
          ) : (
            <div className="flex-1 flex flex-col">
              <div className="p-3 border-b bg-white dark:bg-gray-800 flex items-center">
                <h2 className="font-bold">{activeChat.name}</h2>
                {activeChat.description && <span className="ml-2 text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-1 rounded">{activeChat.description}</span>}
              </div>

              <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-gray-900">
                {messages.map(m => (
                  <div
                    key={m.id}
                    onContextMenu={(e) => handleContextMenu(e, m)}
                    className={`flex relative ${m.senderId === user.uid ? 'justify-end' : 'justify-start'}`}
                  >
                    <div className={`max-w-xs lg:max-w-md px-3 py-2 rounded-lg ${
                      m.senderId === user.uid ? 'bg-blue-500 text-white' : 'bg-white dark:bg-gray-700 shadow'
                    }`}>
                      <p className="text-sm">{m.text}</p>
                      <p className="text-xs mt-1 opacity-70">
                        {new Date(m.timestamp?.seconds * 1000).toLocaleTimeString()}
                        {m.edited && " • dikemaskini"}
                      </p>
                      {m.reactions && Object.keys(m.reactions).length > 0 && (
                        <div className="flex gap-1 mt-1 text-sm">
                          {Object.entries(m.reactions).map(([e, c]) => (
                            <span key={e} className="bg-gray-200 dark:bg-gray-600 px-1 rounded text-xs">{e}{c}</span>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                ))}
                <div ref={messagesEndRef} />
              </div>

              <div className="p-3 bg-white dark:bg-gray-800 border-t">
                <div className="flex relative">
                  <input
                    type="text"
                    value={newMessage}
                    onChange={e => setNewMessage(e.target.value)}
                    onKeyPress={e => e.key === 'Enter' && sendMessage()}
                    placeholder="Taip mesej..."
                    className="flex-1 p-2 border rounded focus:outline-none dark:bg-gray-700 dark:border-gray-600"
                  />
                  <button onClick={sendMessage} className="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded ml-2">
                    Hantar
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
