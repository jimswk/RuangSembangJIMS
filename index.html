<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JIMS Ruang Sembang</title>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontSize: { 'xs': '0.75rem', 'sm': '0.875rem', 'base': '1rem', 'lg': '1.125rem', 'xl': '1.25rem' }
        }
      }
    }
  </script>

  <!-- Notifikasi Bunyi -->
  <audio id="notificationSound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 h-screen overflow-hidden">
  <div id="root"></div>

  <script type="text/babel">
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyA8L6_srjWF7mk-7k5UGk2vH_klYYOkU5U",
      authDomain: "ruangsembangjimsv2.firebaseapp.com",
      projectId: "ruangsembangjimsv2",
      storageBucket: "ruangsembangjimsv2.firebasestorage.app",
      messagingSenderId: "180755101546",
      appId: "1:180755101546:web:5bd96908400e3f59689713",
      measurementId: "G-76BVBVGYZ1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    const { useState, useEffect, useRef, useCallback } = React;

    // Popup Alert
    const PopupAlert = ({ message, type = "info", onClose }) => {
      useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
      const bgColor = type === "success" ? "bg-green-500" : "bg-blue-500";
      return (
        <div className={`fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded shadow-lg z-50`}>
          {message}
        </div>
      );
    };

    // Context Menu
    const ContextMenu = ({ show, x, y, onClose, onAction }) => {
      if (!show) return null;
      return (
        <div
          className="absolute z-50 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded shadow-lg py-1 text-sm"
          style={{ left: x, top: y }}
          onMouseLeave={onClose}
        >
          {['Info Mesej', 'Balas', 'Salin', 'Reaksi', 'Majukan', 'Sematkan', 'Bintang', 'Sunting', 'Padam'].map(a => (
            <div key={a} className="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer" onClick={() => { onAction(a); onClose(); }}>
              {a}
            </div>
          ))}
        </div>
      );
    };

    // App
    const App = () => {
      const [user, setUser] = useState(null);
      const [isAdmin, setIsAdmin] = useState(false);
      const [loading, setLoading] = useState(true);
      const [alert, setAlert] = useState({ show: false, msg: '', type: 'info' });
      const [darkMode, setDarkMode] = useState(false);
      const [textSize, setTextSize] = useState('base');
      const [authStep, setAuthStep] = useState('login');
      const [contextMenu, setContextMenu] = useState({ show: false, x: 0, y: 0, message: null });
      const [pinnedMessages, setPinnedMessages] = useState([]);

      const notificationSound = document.getElementById('notificationSound');

      useEffect(() => {
        const unsub = auth.onAuthStateChanged(async (u) => {
          if (u) {
            const userRef = db.collection('users').doc(u.uid);
            await userRef.set({
              uid: u.uid,
              email: u.email,
              online: true,
              lastSeen: new Date(),
              photoURL: u.photoURL
            }, { merge: true });
            setUser(u);
            setIsAdmin(u.email?.endsWith('@imi.gov.my'));
          } else {
            setUser(null);
            setIsAdmin(false);
          }
          setLoading(false);
        });

        return () => unsub();
      }, []);

      useEffect(() => {
        if (darkMode) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
      }, [darkMode]);

      const showAlert = (msg, type = 'info') => {
        setAlert({ show: true, msg, type });
        setTimeout(() => setAlert(prev => prev.msg === msg ? { ...prev, show: false } : prev), 3000);
      };

      const playNotif = () => {
        notificationSound.currentTime = 0;
        notificationSound.play().catch(() => {});
      };

      const handleLogout = async () => {
        await db.collection('users').doc(user.uid).update({ online: false, lastSeen: new Date() });
        await auth.signOut();
        setUser(null);
        showAlert("Berjaya log keluar", "success");
      };

      if (loading) return <div className="flex items-center justify-center h-screen">Memuatkan...</div>;

      return (
        <div className={`flex flex-col h-screen ${textSize}`}>
          {alert.show && <PopupAlert message={alert.msg} type={alert.type} onClose={() => setAlert({ ...alert, show: false })} />}
          {user ? (
            <ChatApp
              user={user}
              isAdmin={isAdmin}
              darkMode={darkMode}
              setDarkMode={setDarkMode}
              textSize={textSize}
              setTextSize={setTextSize}
              handleLogout={handleLogout}
              showAlert={showAlert}
              contextMenu={contextMenu}
              setContextMenu={setContextMenu}
              playNotif={playNotif}
              pinnedMessages={pinnedMessages}
              setPinnedMessages={setPinnedMessages}
            />
          ) : (
            <AuthScreen setAuthStep={setAuthStep} authStep={authStep} showAlert={showAlert} />
          )}
          {contextMenu.show && (
            <ContextMenu
              show={contextMenu.show}
              x={contextMenu.x}
              y={contextMenu.y}
              onClose={() => setContextMenu({ show: false })}
              onAction={(action) => {
                const msg = contextMenu.message;
                if (action === 'Padam') {
                  db.collection('messages').doc(msg.id).delete();
                } else if (action === 'Sematkan') {
                  setPinnedMessages(prev => [...prev, msg]);
                  showAlert("Mesej disematkan", "success");
                } else if (action === 'Reaksi') {
                  // Reaksi akan ditangani dalam chat bubble
                }
                setContextMenu({ show: false });
              }}
            />
          )}
        </div>
      );
    };

    // AuthScreen
    const AuthScreen = ({ authStep, setAuthStep, showAlert }) => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [confirm, setConfirm] = useState('');

      const submit = async (e) => {
        e.preventDefault();
        try {
          if (authStep === 'login') {
            await auth.signInWithEmailAndPassword(email, password);
            showAlert("Log masuk berjaya!", "success");
          } else if (authStep === 'register') {
            if (password !== confirm) return showAlert("Kata laluan tidak sepadan");
            const { user } = await auth.createUserWithEmailAndPassword(email, password);
            await db.collection('users').doc(user.uid).set({ email, uid: user.uid, online: true, lastSeen: new Date() });
            showAlert("Akaun berjaya didaftarkan!", "success");
          } else if (authStep === 'forgot') {
            await auth.sendPasswordResetEmail(email);
            showAlert("Pautan set semula dihantar ke emel.", "success");
            setAuthStep('login');
          }
        } catch (err) {
          showAlert(err.message, "error");
        }
      };

      return (
        <div className="flex h-full items-center justify-center bg-gray-50 dark:bg-gray-900">
          <div className="w-96 p-8 bg-white dark:bg-gray-800 rounded shadow">
            <h2 className="text-2xl font-bold mb-6 text-center">{authStep === 'login' ? 'Log Masuk' : authStep === 'register' ? 'Daftar' : 'Lupa Kata Laluan'}</h2>
            <form onSubmit={submit}>
              <input type="email" placeholder="Emel" value={email} onChange={e => setEmail(e.target.value)} required className="w-full p-2 mb-4 border rounded dark:bg-gray-700" />
              {authStep !== 'forgot' && <input type="password" placeholder="Kata Laluan" value={password} onChange={e => setPassword(e.target.value)} required className="w-full p-2 mb-4 border rounded dark:bg-gray-700" />}
              {authStep === 'register' && <input type="password" placeholder="Sahkan" value={confirm} onChange={e => setConfirm(e.target.value)} required className="w-full p-2 mb-4 border rounded dark:bg-gray-700" />}
              <button type="submit" className="w-full bg-blue-500 hover:bg-blue-600 text-white p-2 rounded">Hantar</button>
            </form>
            <div className="mt-4 text-center">
              {authStep === 'login' ? (
                <>
                  <div><a onClick={() => setAuthStep('forgot')} className="text-blue-500 cursor-pointer">Lupa kata laluan?</a></div>
                  <div><a onClick={() => setAuthStep('register')} className="text-blue-500 cursor-pointer">Daftar akaun</a></div>
                </>
              ) : (
                <div><a onClick={() => setAuthStep('login')} className="text-blue-500 cursor-pointer">Sudah ada akaun? Log masuk</a></div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ChatApp
    const ChatApp = ({
      user, isAdmin, darkMode, setDarkMode, textSize, setTextSize,
      handleLogout, showAlert, contextMenu, setContextMenu, playNotif,
      pinnedMessages, setPinnedMessages
    }) => {
      const [channels, setChannels] = useState([]);
      const [onlineUsers, setOnlineUsers] = useState([]);
      const [activeChat, setActiveChat] = useState(null);
      const [messages, setMessages] = useState([]);
      const [newMessage, setNewMessage] = useState('');
      const [searchQuery, setSearchQuery] = useState('');
      const [showCreate, setShowCreate] = useState(false);
      const [newChan, setNewChan] = useState('');
      const [newDesc, setNewDesc] = useState('');
      const [showGroup, setShowGroup] = useState(false);
      const [selectedUsers, setSelectedUsers] = useState([]);
      const [typing, setTyping] = useState('');
      const messagesEndRef = useRef(null);
      const typingTimeoutRef = useRef(null);

      const scrollToBottom = () => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });

      // Sync channels & users
      useEffect(() => {
        const unsubCh = db.collection('channels').onSnapshot(s => {
          setChannels(s.docs.map(d => ({ id: d.id, ...d.data() })));
        });
        const unsubU = db.collection('users').onSnapshot(s => {
          setOnlineUsers(s.docs.map(d => ({ id: d.id, ...d.data() })));
        });
        return () => { unsubCh(); unsubU(); };
      }, []);

      // Sync messages
      useEffect(() => {
        if (!activeChat?.id) return;
        const unsub = db.collection('messages')
          .where('chatId', '==', activeChat.id)
          .orderBy('timestamp', 'asc')
          .onSnapshot(snap => {
            const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            setMessages(msgs);
            const newMsg = msgs.filter(m => m.timestamp?.seconds > (Date.now() / 1000) - 30 && m.senderId !== user.uid);
            if (newMsg.length > 0) playNotif();
            scrollToBottom();
          });

        // Typing indicator
        const typingRef = db.collection('typing').doc(activeChat.id);
        const unsubTyping = typingRef.onSnapshot(s => {
          const data = s.data();
          if (data && data.userId !== user.uid) {
            setTyping(data.email);
            setTimeout(() => setTyping(''), 3000);
          }
        });

        return () => { unsub(); unsubTyping(); };
      }, [activeChat]);

      const sendTyping = () => {
        if (!activeChat) return;
        db.collection('typing').doc(activeChat.id).set({
          userId: user.uid,
          email: user.email,
          timestamp: new Date()
        });
        if (typingTimeoutRef.current) clearTimeout(typingTimeoutRef.current);
        typingTimeoutRef.current = setTimeout(() => {
          db.collection('typing').doc(activeChat.id).delete();
        }, 2000);
      };

      const sendMessage = async () => {
        if (!newMessage.trim() || !activeChat) return;
        await db.collection('messages').add({
          text: newMessage,
          senderId: user.uid,
          senderEmail: user.email,
          chatId: activeChat.id,
          timestamp: new Date(),
          type: activeChat.type
        });
        setNewMessage('');
      };

      const createChannel = async () => {
        if (!newChan) return;
        await db.collection('channels').add({
          name: newChan,
          description: newDesc,
          createdBy: user.uid,
          createdAt: new Date()
        });
        setNewChan('');
        setNewDesc('');
        setShowCreate(false);
        showAlert(`Channel "${newChan}" dibuat!`, "success");
      };

      const createGroupDM = () => {
        if (selectedUsers.length === 0) return;
        const ids = [user.uid, ...selectedUsers].sort();
        const dmId = ids.join('_');
        const name = [user.email, ...selectedUsers.map(u => onlineUsers.find(ou => ou.id === u)?.email)].join(', ');
        setActiveChat({ type: 'dm', id: dmId, name });
        setSelectedUsers([]);
        setShowGroup(false);
      };

      const addReaction = async (msgId, emoji) => {
        const ref = db.collection('messages').doc(msgId);
        const snap = await ref.get();
        const reactions = snap.data()?.reactions || {};
        reactions[emoji] = (reactions[emoji] || 0) + 1;
        await ref.update({ reactions });
      };

      const leaveChat = () => setActiveChat(null);
      const deleteChannel = async (id) => {
        if (window.confirm("Padam channel ini?")) {
          await db.collection('channels').doc(id).delete();
          await db.collection('messages').where('chatId', '==', id).get().then(s => s.docs.forEach(d => d.ref.delete()));
          if (activeChat?.id === id) setActiveChat(null);
          showAlert("Channel dipadam", "success");
        }
      };

      const filteredChannels = channels.filter(c => c.name.toLowerCase().includes(searchQuery.toLowerCase()));
      const filteredUsers = onlineUsers.filter(u => u.online && u.email.toLowerCase().includes(searchQuery.toLowerCase()));

      return (
        <div className="flex h-full">
          {/* Sidebar */}
          <div className="w-80 bg-white dark:bg-gray-800 border-r dark:border-gray-700 flex flex-col">
            <div className="p-4 border-b dark:border-gray-700">
              <h1 className="text-xl font-bold">JIMS Sembang</h1>
              <button onClick={handleLogout} className="text-sm text-red-500">Keluar</button>
            </div>

            <div className="p-2">
              <input
                type="text"
                placeholder="Cari channel/pengguna..."
                value={searchQuery}
                onChange={e => setSearchQuery(e.target.value)}
                className="w-full p-2 border rounded dark:bg-gray-700"
              />
            </div>

            <div className="p-2 space-y-2 text-sm">
              <label className="flex items-center">
                <input type="checkbox" checked={darkMode} onChange={() => setDarkMode(!darkMode)} className="mr-2" />
                Dark Mode
              </label>
              <select value={textSize} onChange={e => setTextSize(e.target.value)} className="w-full p-1 border rounded dark:bg-gray-700">
                {['xs', 'sm', 'base', 'lg', 'xl'].map(s => <option key={s} value={s}>{s}</option>)}
              </select>
            </div>

            <div className="flex-1 overflow-y-auto p-2">
              {/* Online Users */}
              <h3 className="font-semibold mb-2">Online ({onlineUsers.filter(u => u.online).length})</h3>
              {filteredUsers.map(u => (
                <div key={u.id} className="flex items-center p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm cursor-pointer" onClick={() => setActiveChat({ type: 'dm', id: [user.uid, u.uid].sort().join('_'), name: u.email })}>
                  <div className="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-xs">{u.email[0].toUpperCase()}</div>
                  <span className="ml-2">{u.email}</span>
                  <span className="text-xs opacity-60 ml-auto">{u.online ? 'Online' : 'Offline'}</span>
                </div>
              ))}

              <div className="flex justify-between mt-4">
                <h3 className="font-semibold">Channels</h3>
                {isAdmin && <button onClick={() => setShowCreate(true)} className="text-xs bg-blue-100 dark:bg-blue-900 px-1 rounded">+</button>}
                <button onClick={() => setShowGroup(true)} className="text-xs bg-gray-100 dark:bg-gray-700 px-1 rounded">Group DM</button>
              </div>

              {showCreate && isAdmin && (
                <div className="p-2 border rounded bg-gray-50 dark:bg-gray-700 mb-2">
                  <input placeholder="Nama channel" value={newChan} onChange={e => setNewChan(e.target.value)} className="w-full p-1 mb-1 border rounded text-sm dark:bg-gray-600" />
                  <textarea placeholder="Deskripsi" value={newDesc} onChange={e => setNewDesc(e.target.value)} className="w-full p-1 mb-1 border rounded text-sm dark:bg-gray-600" rows="1" />
                  <button onClick={createChannel} className="bg-green-500 text-white px-2 py-0.5 text-xs rounded mr-1">Buat</button>
                  <button onClick={() => setShowCreate(false)} className="bg-gray-300 dark:bg-gray-600 px-2 py-0.5 text-xs rounded">Batal</button>
                </div>
              )}

              {showGroup && (
                <div className="p-2 border rounded bg-gray-50 dark:bg-gray-700 mb-2">
                  <p className="text-xs mb-1">Pilih pengguna:</p>
                  {onlineUsers.filter(u => u.id !== user.uid).map(u => (
                    <label key={u.id} className="flex items-center text-xs p-1">
                      <input type="checkbox" checked={selectedUsers.includes(u.id)} onChange={e => {
                        if (e.target.checked) setSelectedUsers(s => [...s, u.id]);
                        else setSelectedUsers(s => s.filter(id => id !== u.id));
                      }} className="mr-1" />
                      {u.email}
                    </label>
                  ))}
                  <button onClick={createGroupDM} className="bg-blue-500 text-white px-2 py-0.5 text-xs rounded mr-1">Buat Group</button>
                  <button onClick={() => setShowGroup(false)} className="bg-gray-300 dark:bg-gray-600 px-2 py-0.5 text-xs rounded">Batal</button>
                </div>
              )}

              {filteredChannels.map(c => (
                <div key={c.id} className="flex justify-between items-center p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm">
                  <span onClick={() => setActiveChat({ type: 'channel', id: c.id, name: c.name, description: c.description })} className="cursor-pointer">#{c.name}</span>
                  {activeChat?.id === c.id && <button onClick={leaveChat} className="text-xs text-red-500">Keluar</button>}
                  {isAdmin && <button onClick={() => deleteChannel(c.id)} className="text-xs text-red-700">×</button>}
                </div>
              ))}
            </div>
          </div>

          {/* Chat Area */}
          {!activeChat ? (
            <div className="flex-1 flex items-center justify-center text-gray-500">Pilih channel atau pengguna</div>
          ) : (
            <div className="flex-1 flex flex-col">
              <div className="p-3 border-b bg-white dark:bg-gray-800 flex items-center justify-between">
                <h2 className="font-bold">{activeChat.name}</h2>
                {activeChat.description && <span className="text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-1 rounded">{activeChat.description}</span>}
              </div>

              {/* Pinned Messages */}
              {pinnedMessages.length > 0 && (
                <div className="bg-yellow-50 dark:bg-yellow-900 border-b p-2 text-xs">
                  {pinnedMessages.map(m => (
                    <div key={m.id} className="italic">📌 {m.text.substring(0, 30)}...</div>
                  ))}
                </div>
              )}

              {/* Messages */}
              <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-gray-900" onContextMenu={e => e.preventDefault()}>
                {messages.map(m => (
                  <div
                    key={m.id}
                    onContextMenu={e => {
                      e.preventDefault();
                      setContextMenu({ show: true, x: e.pageX, y: e.pageY, message: m });
                    }}
                    className={`flex ${m.senderId === user.uid ? 'justify-end' : 'justify-start'}`}
                  >
                    <div className={`max-w-xs lg:max-w-md px-3 py-2 rounded-lg relative ${
                      m.senderId === user.uid ? 'bg-blue-500 text-white' : 'bg-white dark:bg-gray-700 shadow'
                    }`}>
                      <p className="text-sm">{m.text}</p>
                      <p className="text-xs mt-1 opacity-70">{new Date(m.timestamp?.seconds * 1000).toLocaleTimeString()}</p>
                      {m.reactions && (
                        <div className="flex gap-1 mt-1 text-sm">
                          {Object.entries(m.reactions).map(([emoji, count]) => (
                            <span key={emoji} className="bg-gray-200 dark:bg-gray-600 px-1 rounded text-xs">{emoji}{count}</span>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                ))}
                {typing && <div className="text-xs text-gray-500 px-4">💬 {typing} sedang menaip...</div>}
                <div ref={messagesEndRef} />
              </div>

              {/* Input */}
              <div className="p-3 bg-white dark:bg-gray-800 border-t">
                <div className="flex">
                  <input
                    type="text"
                    value={newMessage}
                    onChange={e => { setNewMessage(e.target.value); sendTyping(); }}
                    onKeyPress={e => e.key === 'Enter' && sendMessage()}
                    placeholder="Taip mesej..."
                    className="flex-1 p-2 border rounded-l focus:outline-none dark:bg-gray-700 dark:border-gray-600"
                  />
                  <button onClick={sendMessage} className="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-r">Hantar</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
